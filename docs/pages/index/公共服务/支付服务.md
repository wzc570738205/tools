<!--
 * @Author: wangzhichiao<https://github.com/wzc570738205>
 * @Date: 2020-12-04 14:03:18
 * @LastEditors: wangzhichiao<https://github.com/wzc570738205>
 * @LastEditTime: 2020-12-04 15:10:38
-->
## 服务目的

整合各个支付体系，为业务系统提供统一接口，降低与业务系统的耦合度。目前仅接入微信服务商模式，当多个业务系统共用同一个服务商时，可使用一个服务。

## 如何使用
1、拉取代码https://59.110.237.110/svn/项目/应用软件公共组件/支付服务/code/publicPaymentServices  
2、创建数据库，执行sqlShell/payment_service.sql  
3、修改配置项：  
````
    数据库信息
        spring.datasource.druid.url
        spring.datasource.druid.username
        spring.datasource.druid.password
    redis信息
        redis.hostName
        redis.port或spring.redis.cluster.nodes
        redis.password
    微信服务商信息
        appId -- 服务商appId
        mch_id -- 服务商商户号
        cert_path -- 服务器上的服务商证书存放路径
        key_path -- 服务器上的服务商私钥存放路径
        cert_serial_no -- 服务商证书序列号
        key -- 服务商api密钥
        platform_cert_no -- 平台证书序列号
    fastDfs信息，用于下载商户入驻所需图片
        tracker_server
        http.tracker_http_port
    是否开启业务系统接口验签功能
        sign_interceptor_switch
````        
4、部署服务

## 业务流程说明
### 1、业务系统不支持其他商户对接
* 业务系统首先调用注册接口，先注册至公共服务以获取业务系统和公共服务之间的api密钥。  
* 联系服务商管理员在微信服务商公众平台进行特约商户申请，获取二级商户号；  
* 通过前两步获取到的api密钥和二级商户号即可发起支付，退款等功能。  
### 2、业务系统支持其他商户对接，如旅游小程序，支持酒店商家，美食商家入驻。
* 业务系统首先调用注册接口，先注册至公共服务以获取业务系统和公共服务之间的api密钥。  
* 业务系统做为平台，根据其下要入驻的商户信息，发起微信商户入驻获取各自对应的二级商户号，并进行保存。  
* 当发起支付或退款等业务时，应根据商户主体，应传入第二步获取的对应二级商户号。

## 接口说明
### 一、请求方式说明
* 现提供的接口可通过http，参数以json格式发起请求。  
* 部分接口需携带签名信息，具体查看业务系统签名介绍。   
* 公共服务返回到业务系统的参数都封装在data中。  
### 二、接口介绍
#### 1、公共服务接口
#### (1)、注册至公共服务

##### 业务功能
该接口为对接公共服务的第一步，根据该接口获取api密钥并开通对接权限。
此功能用于小程序发起微信支付时，获取所必须的参数。

##### 处理流程
* 业务系统携带自己的系统名称等要素信息，向公共服务发起注册请求。  
* 公共服务收到请求为业务系统分配api密钥，并开通该业务系统对接权限。  

##### 接口路径
/v1.0/register/registerToPaymentService

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| systemName | 业务系统名称 | String | Y | |

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| id | 系统来源 | String | Y | |
| systemName | 业务系统名称 | String | Y | |
| status | 启用状态 | Integer | Y | 1：启用；2：禁用 |
| apiKey | api密钥 | String | Y | |

#### 2、微信服务商接口
#### (1)、小程序支付

##### 业务功能
该接口用于小程序发起微信支付时，获取所必须的参数。

##### 处理流程
* 业务系统上送小程序公众账号ID、二级商户ID、支付单号、支付金额等要素信息。  
* 支付公共服务对上送的要素信息进行必输项、商户校验等相关校验后，发往微信支付系统进行校验；校验通过后调用微信JSAPI支付接口。  
* 支付公共服务根据微信返回结果返回给业务系统。  

##### 接口路径
/v1.0/payment/pay

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subAppId | 小程序AppId | String | Y | |
| subMchId | 二级商户号 | String | Y | |
| openId | 用户标识 | String | Y | 用户在小程序下的唯一标识 |
| orderNo | 业务系统订单号 | String | Y | 禁止包含'_'字符 |
| totalFee | 订单总金额（元） | BigDecimal | Y | 以元为单位。例：0.01 |
| body | 商品名称 | String | Y | 禁止包含'_'字符 |
| systemSource | 系统来源 | Integer | Y | 传入由注册接口返回的系统来源 |
| systemNotifyUrl | 业务系统回调url | String | Y | 接收公共服务异步通知回调地址，通知url必须为直接可访问的url，不能携带参数 |
| profitSharing | 是否开启分账 | String | N | Y：开启，N：不开启。默认开启 |
| payChannel | 支付渠道 | String | Y | 目前只有微信支付可以对接，所以固定传“wx” |

##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| nonceStr | 随机字符串 | String | Y | |
| package | 预支付交易会话标识 | String | Y | |
| timeStamp | 时间戳 | String | Y | |
| paySign | 签名 | String | Y | |
| signType | 签名类型 | String | Y | |

##### 请求失败应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_msg | 返回信息 | String | Y | |
| err_code | 错误代码 | String | Y | |
| err_code_des | 错误代码描述 | String | Y | |

#### (2)、NATIVE支付

##### 业务功能
此功能由业务系统发起一笔用户主动扫描二维码的支付交易，并同步返回请求结果。

##### 处理流程
* 业务系统上送小程序公众账号ID、二级商户ID、支付单号、支付金额等要素信息。  
* 支付公共服务对上送的要素信息进行必输项、商户校验等相关校验后，发往微信支付系统进行校验；校验通过后调用微信NATIVE支付接口。  
* 支付公共服务根据微信返回结果返回给业务系统。  

##### 接口路径
/v1.0/payment/nativePay

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| orderNo | 业务系统订单号 | String | Y | 禁止包含'_'字符 |
| totalFee | 订单总金额（元） | BigDecimal | Y | 以元为单位。例：0.01 |
| body | 商品名称 | String | Y | 禁止包含'_'字符 |
| systemSource | 系统来源 | Integer | Y | 传入由注册接口返回的系统来源 |
| systemNotifyUrl | 业务系统回调url | String | Y | 接收公共服务异步通知回调地址，通知url必须为直接可访问的url，不能携带参数 |
| profitSharing | 是否开启分账 | String | N | Y：开启，N：不开启。默认开启 |
| payChannel | 支付渠道 | String | Y | 目前只有微信支付可以对接，所以固定传“wx” |

##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| package | 预支付交易会话标识 | String | Y | |
| codeUrl | 二维码链接 | String | Y | 此url用于生成支付二维码，然后提供给用户进行扫码支付 |

##### 请求失败应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| err_code | 错误代码 | String | Y | |
| err_code_des | 错误代码描述 | String | Y | |

#### (3)、付款码支付

##### 业务功能
此功能用于业务系统需要扫码枪/扫码盒子扫取用户付款码，以此进行支付交易,由公共服务完成支付，并同步返回支付结果；

##### 处理流程
* 业务系统上送小程序公众账号ID、二级商户ID、支付单号、支付金额等要素信息。  
* 支付公共服务对上送的要素信息进行必输项、商户校验等相关校验后，发往微信支付系统进行校验；校验通过后调用微信付款码支付接口。  
* 支付公共服务根据微信返回结果返回给业务系统。  

##### 接口路径
/v1.0/payment/codePay

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| orderNo | 业务系统订单号 | String | Y | 禁止包含'_'字符 |
| totalFee | 订单总金额（元） | BigDecimal | Y | 以元为单位。例：0.01 |
| body | 商品名称 | String | Y | 禁止包含'_'字符 |
| systemSource | 系统来源 | Integer | Y | 传入由注册接口返回的系统来源 |
| profitSharing | 是否开启分账 | String | N | Y：开启，N：不开启。默认开启 |
| authCode | 付款码 | String | N | 设备扫取得到的用户付款码 |
| payChannel | 支付渠道 | String | Y | 目前只有微信支付可以对接，所以固定传“wx” |

##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | |
| result_code | 交易结果 | String | Y | SUCCESS：支付成功 |
| transaction_id | 微信支付订单号 | String | Y | |
| return_msg | 返回信息 | String | Y |  |

##### 请求失败应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | |
| result_code | 交易结果 | String | Y | |
| err_code | 错误代码 | String | Y | 详细参见错误列表,注：当该参数返回USERPAYING时，代表该笔支付需用户输入密码完成支付。此类情况，可原参数继续调用该接口，查询用户支付状态 |
| err_code_des | 错误描述 | String | Y | 错误返回的信息描述 |

#### (4)、查询订单支付状态

##### 业务功能
该接口提供所有微信支付订单的查询，商户可以通过该接口主动查询订单状态，完成下一步的业务逻辑。

##### 处理流程
需要调用该接口的情况：
* 当商户后台、网络、服务器等出现异常，商户系统最终未接收到支付通知；  
* 调用支付接口后，返回系统错误或未知交易状态情况；  
* 调用被扫支付API，返回USERPAYING的状态；  
* 调用关单或撤销接口API之前，需确认支付状态；  

##### 接口路径
/v1.0/payment/orderQuery

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| orderNo | 业务系统订单号 | String | Y | 禁止包含'_'字符 |
| systemSource | 系统来源 | Integer | Y | 传入由注册接口返回的系统来源 |
| payChannel | 支付渠道 | String | Y | 目前只有微信支付可以对接，所以固定传“wx” |

##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL，此字段是通信标识，非交易标识，交易是否成功需要查看trade_state来判断 |
| return_msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因 |

以下字段在return_code为SUCCESS的时候有返回
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| appid | 服务商的APPID | String | Y | |
| mch_id | 服务商的商户号 | String | Y | |
| sub_appid | 子商户公众账号ID | String | Y | |
| sub_mch_id | 子商户号 | String | Y | |
| nonce_str | 随机字符串 | String | Y | |
| sign | 签名 | String | Y | |
| result_code | 业务结果 | String | Y | SUCCESS/FAIL |
| err_code | 错误代码 | String | Y | 详细参见错误列表 |
| err_code_des | 错误代码描述 | String | Y | |

以下字段在return_code 、result_code、trade_state都为SUCCESS时有返回 ，如trade_state不为 SUCCESS，则只返回out_trade_no（必传）和attach（选传）。注：只列取关键字段

| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| device_info | 设备号 | String | N | 微信支付分配的终端设备号 |
| openid | 用户标识 | String | Y | 用户在商户appid下的唯一标识 |
| is_subscribe | 是否关注公众账号 | String | Y | 用户是否关注公众账号，Y-关注，N-未关注（机构商户不返回） |
| sub_openid | 用户子标识 | String | N | 用户在子商户appid下的唯一标识 |
| sub_is_subscribe | 是否关注子公众账号 | String | N | 用户是否关注子公众账号，Y-关注，N-未关注（机构商户不返回） |
| trade_type | 交易类型 | String | Y | 调用接口提交的交易类型，取值如下：JSAPI，NATIVE，APP，MICROPAY |
| trade_state | 交易状态 | String | Y | SUCCESS—支付成功,REFUND—转入退款,NOTPAY—未支付,CLOSED—已关闭,REVOKED—已撤销(刷卡支付),USERPAYING--用户支付中,PAYERROR--支付失败(其他原因，如银行返回失败) |
| bank_type | 付款银行 | String | Y | 银行类型，采用字符串类型的银行标识 |
| detail | 商品详情 | String | N | {"discount_detail":[{"goods_id":"iphone6s_16G","goods_name":"iPhone6s 16G","coupon_batch_id":888,"coupon_id":666888,"coupon_fee":1000},{"goods_id":"iphone6s_32G","goods_name":"iPhone6s 32G","coupon_batch_id":999,"coupon_id":666999,"coupon_fee":1500}]} |
 | total_fee | 标价金额 | Integer | Y | 订单总金额，单位为分 |
 | fee_type | 标价币种 | String | Y | 货币类型，符合ISO 4217标准的三位字母代码，默认人民币：CNY |
 | transaction_id | 微信支付订单号 | String | Y | 微信支付订单号 |
 | out_trade_no | 商户订单号 | String | Y | 商户系统内部订单号 |
 | time_end | 支付完成时间 | String | Y | 订单支付时间，格式为yyyyMMddHHmmss，如2009年12月25日9点10分10秒表示为20091225091010 |
 | trade_state_desc | 交易状态描述 | String | Y | 对当前查询订单状态的描述和下一步操作的指引 |

#### (5)、申请退款

##### 业务功能
业务系统可以对已支付成功的订单，主动发起退款请求。

##### 业务规则
* 交易时间超过一年的订单无法提交退款；  
* 微信支付退款支持单笔交易分多次退款，多次退款需要提交原支付订单的商户订单号和设置不同的退款单号。申请退款总金额不能超过订单金额。 一笔退款失败后重新提交，请不要更换退款单号，请使用原商户退款单号。

##### 处理流程
* 业务系统向公共服务发送退款请求；  
* 公共服务向微信发起退款请求；  
* 微信向公共服务返回处理结果，再由公共服务将结果同步返回至业务系统；  

##### 接口路径
/v1.0/refundMent/refund

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| orderNo | 业务系统订单号 | String | Y | |
| refundDesc | 退款原因 | String | Y | |
| refundNo | 业务系统退款单号 | String | Y | 禁止包含'_'字符, 一笔退款失败后重新提交，请不要更换退款单号，请使用原退款单号。 |
| systemSource | 系统来源 | Integer | Y | 传入由注册接口返回的系统来源 |
| totalFee | 支付总金额（元） | BigDecimal | N | |
| refundFee | 退款金额（元） | BigDecimal | N | |
| systemNotifyUrl | 业务系统回调url | String | Y | |

##### 申请退款成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| result_code | 交易结果 | String | Y | SSUCCESS/FAIL,SUCCESS退款申请接收成功，结果通过退款查询接口查询,FAIL 提交业务失败 |

##### 申请退款失败应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| result_code | 交易结果 | String | Y | SSUCCESS/FAIL,SUCCESS退款申请接收成功，结果通过退款查询接口查询,FAIL 提交业务失败 |
| return_msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因：签名失败,参数格式校验错误 |
| err_code | 错误代码 | String | Y | 详细参见错误列表 |
| err_code_des | 错误描述 | String | Y | 错误返回的信息描述 |

#### (6)、查询退款状态

##### 业务功能
提交退款申请后，通过调用该接口查询退款状态。退款有一定延时，用零钱支付的退款20分钟内到账，银行卡支付的退款3个工作日后重新查询退款状态。

##### 处理流程
* 业务系统向公共服务发送退款查询请求；  
* 公共服务向微信发起退款查询请求；  
* 微信向公共服务返回查询结果，再由公共服务将结果同步返回至业务系统；  

##### 接口路径
/v1.0/refundMent/refundQuery

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| refundNo | 业务系统退款单号 | String | Y | |
| systemSource | 系统来源 | Integer | Y | 传入由注册接口返回的系统来源 |

##### 应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| return_msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因:签名失败,参数格式校验错误 |

以下字段在return_code为SUCCESS的时候有返回  
$n和$m为下标，从0开始编号。微信退款查询支持支付单号查询，一个支付单号可以进行多次退款，若多次退款后根据支付单号查询，则会有多条退款记录。目前公共服务是根据退款单号查询退款状态，查询结果也只会有一条退款记录，所以下标目前都为0。
返回的参数中，和代金券相关的参数暂无需关注。
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,SUCCESS申请成功，退款是否成功查看refund_status_$n |
| return_msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因:签名失败,参数格式校验错误 |
| err_code | 错误码 | String | Y | 错误代码 |
| err_code_des | 错误描述 | String | Y | 错误代码描述 |
| appid | 服务商的APPID | String | Y | |
| mch_id | 商户号 | String | Y | |
| sub_mch_id | 子商户号 | String | Y | |
| nonce_str | 随机字符串 | String | Y | |
| sign | 签名 | String | Y | |
| transaction_id | 微信订单号 | String | Y | |
| out_trade_no | 商户订单号 | String | Y | |
| total_fee | 订单金额 | Integer | Y | 订单总金额，单位为分 |
| settlement_total_fee | 应结订单金额 | Integer | N | 当订单使用了免充值型优惠券后返回该参数，应结订单金额=订单金额-免充值优惠券金额 |
| fee_type | 货币种类 | String | N | 订单金额货币类型，符合ISO 4217标准的三位字母代码，默认人民币：CNY |
| cash_fee | 现金支付金额 | String | N | 现金支付金额，单位为分 |
| refund_count | 退款笔数 | String | Y | 当前返回退款笔数 |
| out_refund_no_$n | 商户退款单号 | String | Y | |
| refund_id_$n | 微信退款单号 | String | Y | |
| refund_channel_$n | 退款渠道 | String | N | ORIGINAL—原路退款,BALANCE—退回到余额,OTHER_BALANCE—原账户异常退到其他余额账户,OTHER_BANKCARD—原银行卡异常退到其他银行卡 |
| total_refund_count | 订单总退款次数 | Integer | N | 订单总共已发生的部分退款次数，当请求参数传入offset后有返回 |
| refund_fee_$n | 申请退款金额 | Integer | Y | 退款总金额,单位为分 |
| settlement_refund_fee_$n | 退款金额 | String | N | 退款金额=申请退款金额-非充值代金券退款金额，退款金额<=申请退款金额 |
| coupon_type_$n_$m | 代金券类型 | String | N | CASH--充值代金券 NO_CASH---非充值代金券,订单使用代金券时有返回（取值：CASH、NO_CASH） |
| coupon_refund_fee_$n | 总代金券退款金额 | String | N | 代金券退款金额<=退款金额，退款金额-代金券或立减优惠退款金额为现金 |
| coupon_refund_count_$n | 退款代金券使用数量 | String | N | 退款代金券使用数量 |
| coupon_refund_id_$n_$m | 退款代金券ID | String | N | 退款代金券ID |
| coupon_refund_fee_$n_$m | 单个代金券退款金额 | Integer | N | 单个退款代金券支付金额 |
| refund_status_$n | 退款状态 | String | Y | SUCCESS—退款成功,REFUNDCLOSE—退款关闭,PROCESSING—退款处理中,CHANGE—退款异常，退款到银行发现用户的卡作废或者冻结了，导致原路退款银行卡失败，可前往商户平台（pay.weixin.qq.com）-交易中心，手动处理此笔退款。$n为下标，从0开始编号。 |
| refund_account_$n | 退款资金来源 | String | N | REFUND_SOURCE_RECHARGE_FUNDS---可用余额退款/基本账户
,REFUND_SOURCE_UNSETTLED_FUNDS---未结算资金退款 |
| refund_recv_accout_$n | 退款入账账户 | String | N | 取当前退款单的退款入账方,<br>1）退回银行卡：{银行名称}{卡类型}{卡尾号} <br>2）退回支付用户零钱:支付用户零钱 <br>3）退还商户:商户基本账户,商户结算银行账户 <br>4）退回支付用户零钱通:支付用户零钱通 |
| refund_success_time_$n | 退款成功时间 | String | N | 退款代退款成功时间，当退款状态为退款成功时有返回。2016-07-25 15:26:26 |

##### 申请退款失败应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| result_code | 交易结果 | String | Y | SSUCCESS/FAIL,SUCCESS退款申请接收成功，结果通过退款查询接口查询,FAIL 提交业务失败 |
| return_msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因：签名失败,参数格式校验错误 |
| err_code | 错误代码 | String | Y | 详细参见错误列表 |
| err_code_des | 错误描述 | String | Y | 错误返回的信息描述 |

#### (7)、下载交易账单

##### 业务功能
业务系统可以通过该接口下载历史交易清单。比如掉单、系统错误等导致业务系统侧和微信侧数据不一致，通过对账单核对后可校正支付状态。

##### 业务规则
* 微信侧未成功下单的交易不会出现在对账单中。支付成功后撤销的交易会出现在对账单中，跟原支付单订单号一致；  
* 公共服务在每天10点零5，拉取前一天的对账单。建议商户10点30后再获取；  
* 对账单中涉及金额的字段单位为“元”。  

##### 处理流程
* 业务系统向公共服务发送下载交易账单请求；  
* 公共服务向微信发起下载交易账单请求；  
* 微信向公共服务返回请求结果，再由公共服务将结果同步返回至业务系统；  

##### 接口路径
/v1.0/transactionBill/getBillByDate

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| dateString | 查询日期 | String | Y | 20200816 |
| systemSource | 系统来源 | Integer | Y | 传入由注册接口返回的系统来源 |

##### 应答参数
| 字段 | 描述 | 类型 | 备注 |
| ---------- | ---------- | ---------- | ---------- |
| dateString | 交易日期 | String | 20200816 |
| transactionTime | 交易时间 | String | 2017-12-14 15:49:06 |
| appId | 公众账号ID | String | 服务商appId |
| mchId | 一级商户号 | String | 服务商mchId |
| subMchId | 二级商户号 | String | 特约商户subMchId |
| deviceNumber | 设备号 | String | 该笔交易下单时在device_info字段中传入的信息，没填写则留空 |
| wxOrderNo | 微信订单号 | String | 微信支付为该笔订单（或该笔退款对应的订单）分配的订单号 |
| orderNo | 业务系统订单号 | String | 业务系统传入的该笔订单（或该笔退款对应的订单）的订单号 |
| openId | 用户标识 | String | 微信平台为支付用户在公众账号(appid)下分配的唯一标识(openid) |
| tradeType | 交易类型 | String | JSAPI-JSAPI支付（或小程序支付）NATIVE-Native支付 APP-app支付 MWEB-H5支付 MICROPAY-付款码支付
PAP-委托代扣 |
| tradeStatus | 交易状态 | String | SUCCESS—支付成功，说明该行数据为一笔支付成功的订单 REFUND—转入退款，说明该行数据为一笔发起退款成功的退款单 REVOKED—已撤销，说明该行数据为一笔成功撤销的撤销单 |
| payBank | 付款银行 | String | 银行类型，采用字符串类型的银行标识，如CMC_CREDI |
| currencyType | 货币种类 | String | 货币类型，符合ISO 4217标准的三位字母代码，如CNY(人民币) |
| settledAmount | 应结订单金额 | String | 该笔订单的应结算金额（=订单金额-用户使用的免充值券金额） |
| voucherAmount | 代金券或立减优惠金额 | String | 该笔订单中使用的微信支付代金券金额（包括充值券和免充值券），如果未使用代金券、或该行数据为退款或撤销则展示0.00，单位元，保留到小数点后2位 |
| wxRefundNo | 微信退款单号 | String | 微信支付为该笔退款分配的退款单号，如果该行数据为订单则展示0 |
| refundNo | 商户退款单号 | String | 商户发起退款时填入的商户退款单号，如果该行数据为订单则展示0 |
| refundAmount | 退款金额 | String | |
| rechargeRefundAmount | 代金券或立减优惠退款金额 | String | 退款金额中包含的充值券退款金额，如果该行数据为订单或没有充值券退款则展示为0.00，非负数、单位元，保留到小数点后2位 |
| refundType | 退款类型 | String | ORIGINAL—原路退款 BALANCE—转退到用户的微信支付零钱,如果该行数据为订单，则留空 |
| refundStatus | 退款状态 | String | 生成账单文件时该笔退款的状态、后续不会更新，如果该行数据为订单，则留空 SUCCES—退款成功 FAIL—退款失败 PROCESSING—退款处理中 |
| goodName | 商品名称 | String | |
| merchantPacket | 商户数据包 | String | |
| serviceCharge | 手续费 | String | 该笔订单/退款对应的手续费金额，订单对应正数、退款对应负数，单位元，保留小数点后2位 |
| rate | 费率 | String | 该笔交易计费所使用的费率，百分数，如0.60% |
| payAmount | 订单金额 | String | 该笔订单的金额，包括用户支付金额、充值券金额、免充值券金额，如果该行数据为退款或撤销则填0.00，单位元，保留到小数点后2位 |
| applyRefundAmount | 申请退款金额 | String | 商户发起退款的金额，包括退给用户的金额、充值券退款金额、免充值券退款金额，如果该行数据订单则填0.00，单位元，保留到小数点后2位 |
| rateRemark | 费率备注 | String | 如果有特殊费率规则时则加以说明，默认留空 |

#### (8)、添加分账接收方

##### 业务功能
公共服务收到业务系统添加分账接收方请求，向微信发起相关请求。后续可通过发起分账请求将结算后的钱分到该分账接收方。

##### 处理流程
* 业务系统向公共服务发送添加分账接收方请求；  
* 公共服务向微信发起添加分账接收方请求；  
* 微信向公共服务返回请求结果，再由公共服务将结果同步返回至业务系统；  

##### 接口路径
/v1.0/profit/addProfitReceiver

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| receiver | 分账接收方 | String | Y | 分账接收方对象 |
| systemSource | 系统来源 | String | Y | |
分账接受方参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| type | 分账接收方类型 | String | Y | MERCHANT_ID：商户ID PERSONAL_OPENID：个人openid（由父商户APPID转换得到）PERSONAL_SUB_OPENID: 个人sub_openid（由子商户APPID转换得到） |
| account | 分账接收方帐号 | String | Y | 类型是MERCHANT_ID时，是商户ID |
| name | 分账接收方全称 | String | Y | 分账接收方类型是MERCHANT_ID时，是商户全称（必传）,分账接收方类型是PERSONAL_OPENID时，是个人姓名（选传，传则校验）,分账接收方类型是PERSONAL_SUB_OPENID时，是个人姓名（选传，传则校验） |
| relationType | 与分账方的关系类型 | String | N | SERVICE_PROVIDER：服务商 STORE：门店  STAFF：员工 STORE_OWNER：店主 PARTNER：合作伙伴 HEADQUARTER：总部 BRAND：品牌方 DISTRIBUTOR：分销商 USER：用户 SUPPLIER：供应商 CUSTOM：自定义 |
| custom_relation | 自定义的分账关系 | BigDecimal | N | 子商户与接收方具体的关系，本字段最多10个字。 当字段relation_type的值为CUSTOM时，本字段必填当字段relation_type的值不为CUSTOM时，本字段无需填写 |

##### 应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| result_code | 业务结果 | String | Y | SUCCESS：添加分账接收方成功 FAIL ：提交业务失败 |
| return_msg | 返回信息 | String | N | 返回信息，如非空，为错误原因。 |
| err_code | 错误代码 | String | N | 错误代码 |
| err_code_des | 错误代码描述 | String | N | 错误代码描述 |

#### (9)、发起单/多次分账

##### 业务功能
单次分账请求按照传入的分账接收方账号和资金进行分账，同时会将订单剩余的待分账金额解冻给特约商户。故操作成功后，订单不能再进行分账，也不能进行分账完结。  
多次分账请求仅会按照传入的分账接收方进行分账，不会对剩余的金额进行任何操作。故操作成功后，在待分账金额不等于零时，订单依旧能够再次进行分账。确认分账完成后，可调用‘分账完结接口’，将资金释放给二级商户。


##### 处理流程
* 业务系统向公共服务发送分账请求；  
* 公共服务向微信发起分账请求；  
* 微信向公共服务返回请求结果，再由公共服务将结果同步返回至业务系统；  

##### 接口路径
单次分账：/v1.0/profit/profitSharing  
多次分账：/v1.0/profit/multiProfitSharing  

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| transactionId | 微信订单号 | String | Y | |
| outOrderNo | 业务系统订单号 | String | Y | |
| receiver | 分账接收方 | String | Y | 分账接收方列表，不超过50个json对象，不能设置出资子商户作为分账接受方 |
| systemSource | 系统来源 | String | Y | |
分账接受方参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| type | 分账接收方类型 | String | Y | MERCHANT_ID：商户ID PERSONAL_OPENID：个人openid（由父商户APPID转换得到）PERSONAL_SUB_OPENID: 个人sub_openid（由子商户APPID转换得到） |
| account | 分账接收方帐号 | String | Y | 类型是MERCHANT_ID时，是商户ID |
| amount | 分账金额，单位为元 | String | Y | 不能超过原订单支付金额及最大分账比例金额 |
| description | 分账的原因描述 | String | N | 服务商抽润 |

##### 应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| result_code | 业务结果 | String | Y | SUCCESS：添加分账接收方成功 FAIL ：提交业务失败 |
| return_msg | 返回信息 | String | N | 返回信息，如非空，为错误原因。 |
| err_code | 错误代码 | String | N | 错误代码 |
| err_code_des | 错误代码描述 | String | N | 错误代码描述 |

#### (10)、查询分账结果

##### 业务功能
发起分账请求后，可调用此接口查询分账结果；发起分账完结请求后，可调用此接口查询分账完结的执行结果。

##### 处理流程
* 业务系统向公共服务发送查询分账请求；  
* 公共服务向微信发起查询分账请求；  
* 微信向公共服务返回请求结果，再由公共服务将结果同步返回至业务系统；  

##### 接口路径
/v1.0/profit/profitQuery

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| transactionId | 微信订单号 | String | Y | |
| outOrderNo | 业务系统订单号 | String | Y | |
| systemSource | 系统来源 | String | Y | |

##### 应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| result_code | 业务结果 | String | Y | SUCCESS：分账申请接收成功，结果通过status判断 |
| return_msg | 返回信息 | String | N | 返回信息，如非空，为错误原因。 |
| err_code | 错误代码 | String | N | 错误代码 |
| err_code_des | 错误代码描述 | String | N | 错误代码描述 |

以下字段在return_code和result_code都为SUCCESS的时候返回
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| order_id | 微信分账单号 | String | Y | 返回信息，如非空，为错误原因 |
| status | 分账单状态 | String | Y | 分账单状态： ACCEPTED—受理成功 PROCESSING—处理中 FINISHED—处理完成 CLOSED—处理失败，已关单 |
| receivers | 分账接收方列表 | String | N | 返回信息，如非空，为错误原因 |

分账接受方(receivers)参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| type | 分账接收方类型 | String | Y | MERCHANT_ID：商户ID PERSONAL_OPENID：个人openid（由父商户APPID转换得到）PERSONAL_SUB_OPENID: 个人sub_openid（由子商户APPID转换得到） |
| account | 分账接收方帐号 | String | Y | 类型是MERCHANT_ID时，是商户ID |
| amount | 分账金额，单位为元 | Integer | Y | 分账金额，单位为分，只能为整数，不能超过原订单支付金额及最大分账比例金额 |
| description | 分账的原因描述 | String | Y | 分账的原因描述，分账账单中需要体现 |
| result | 分账结果 | String | Y | PENDING:待分账 SUCCESS:分账成功 ADJUST:分账失败待调账 RETURNED:已转回分账方 CLOSED: 已关闭 |
| finish_time | 分账完成时间 | String | N | 分账完成时间 |
| fail_reason | 分账失败原因 | String | N | ACCOUNT_ABNORMAL:分账接收账户异常 NO_RELATION： 分账关系已解除 RECEIVER_HIGH_RISK:高风险接收方 |

#### (11)、完结分账

##### 业务功能
* 不需要进行分账的订单，可直接调用本接口将订单的金额全部解冻给特约商户  
* 调用多次分账接口后，需要解冻剩余资金时，调用本接口将剩余的分账金额全部解冻给特约商户业务规则

##### 处理流程
* 业务系统向公共服务发送完结分账请求；  
* 公共服务向微信发起完结分账请求；  
* 微信向公共服务返回请求结果，再由公共服务将结果同步返回至业务系统  

##### 接口路径
/v1.0/profit/profitQuery

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| subMchId | 二级商户号 | String | Y | |
| transactionId | 微信订单号 | String | Y | |
| outOrderNo | 业务系统订单号 | String | Y | 禁止包含'_'字符 |
| description | 分账完结描述 | String | Y | |
| systemSource | 系统来源 | String | Y | |

##### 应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| return_code | 返回状态码 | String | Y | SUCCESS/FAIL,此字段是通信标识，表示接口层的请求结果，并非退款状态 |
| result_code | 业务结果 | String | Y | SUCCESS：分账申请接收成功，结果通过status判断 |
| return_msg | 返回信息 | String | N | 返回信息，如非空，为错误原因。 |
| err_code | 错误代码 | String | N | 错误代码 |
| err_code_des | 错误代码描述 | String | N | 错误代码描述 |

#### (12)、商家入驻

##### 业务功能
业务系统开通公共服务微信支付权限后，需要使用微信入驻功能进行微信入驻后，才能使用公共服务微信支付功能进行交易。

##### 业务规则
* 仅支持二级商户进行微信入驻；  
* 入驻失败或入驻申请中,支持重新入驻，不支持一个二级商户号重复入驻。  
* 入驻成功后返回微信商户号，作为商户进行微信支付的唯一标识。  

##### 处理流程
* 业务系统向公共支付服务发送微信入驻请求；  
* 公共服务完成商户微信入驻处理；  
* 公共服务将申请入驻结果返回给商户。（只代表申请是否成功，待微信审核，调用入驻申请单查询接口查询审核状态）  

##### 接口路径
/v1.0/applyment/sendApplyMent

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| businessCode | 业务申请编号 | String | Y | 业务系统申请单唯一标识，用于查询申请单状态，禁止包含'_'字符 |
| shopName | 门店名称 | String | Y | 经营场景类型为'SALES_SCENES_STORE'时必填 |
| shopAddress | 门店详细地址 | String | Y |  经营场景类型为'SALES_SCENES_STORE'时必填 |
| salesScenesType | 经营场景类型 | String | Y | SALES_SCENES_STORE：线下门店 SALES_SCENES_MINI_PROGRAM：小程序 |
| corporateName | 法人姓名 | String | Y | |
| linkPhone | 法人联系电话 | String | Y | |
| email | 法人联系邮箱 | String | Y | |
| corporateIdCard | 法人身份证号 | String | Y | |
| idCardPeriodBegin | 法人身份证有效期起始日期 | String | Y | 例：2020-08-20 |
| idCardPeriodEnd | 法人身份证有效期结束日期 | String | Y | 例：2020-08-20 |
| idCardUpImgSrc | 法人身份证正面Src | String | Y | 传入fastDfs的图片src路径即可 |
| idCardDownImgSrc | 法人身份证反面Src | String | Y | 传入fastDfs的图片src路径即可 |
| bankCode | 银行卡号 | String | Y | 用于在商户后台体现 |
| realName | 开户人姓名 | String | Y | 对公账户填写企业名称 |
| bankName | 开户行名称 | String | Y | 工商银行，交通银行，招商银行，民生银行，中信银行，浦发银行，兴业银行，光大银行，广发银行，平安银行，北京银行，华夏银行，农业银行，建设银行，邮政储蓄银行，中国银行，宁波银行，招商银行,其他银行 |
| bankCardType | 银行卡类型 | Integer | Y | 1，对公账户。2，个人账户 |
| bankAddressCode | 开户银行省市编码 | String | Y | |
| bankAccountNumber | 开户行行号 | String | N | 开户行名称为'其他银行'时必填 |
| registerCode | 注册号 | String | Y | 统一社会信用代码 |
| registerName | 注册名称 | String | Y | 营业执照上的注册名称 |
| businessLicenceImgSrc | 营业执照照片Src | String | Y | 传入fastDfs的图片src路径即可,传入fastDfs的图片src路径即可 |
| shopOutImgSrc | 门脸照src(多张照片src以英文逗号隔开) | String | N | 经营场景类型为'SALES_SCENES_STORE'时必填,传入fastDfs的图片src路径即可 |
| shopInnerImgSrc | 店内照Src(多张照片src以英文逗号隔开) | String | N | 经营场景类型为'SALES_SCENES_STORE'时必填,传入fastDfs的图片src路径即可 |
| permitCode | 许可证编号 | String | Y | |
| permitImgSrc | 许可证照片src | String | Y | 传入fastDfs的图片src路径即可 |
| systemSource | 系统来源 | String | Y | |
| remark | 备注 | String | Y | |

##### 应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| applyment_id | 微信申请单号 | String | Y | 微信支付分配的申请单号 。可根据该字段是否存在来判断申请是否发起成功。 |

#### (13)、微信入驻状态查询

##### 业务功能
商户进行微信入驻之后，使用该接口进行微信入驻状态查询。

##### 业务规则
只支持查询具体的入驻信息，不支持入驻信息修改。

##### 处理流程
* 业务系统调用微信入驻查询接口到公共服务；  
* 公共服务返回查询结果给商户。

##### 接口路径
/v1.0/applyment/sendApplyMent  

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| businessCode | 业务申请编号 | String | Y | 发起申请入驻时，业务系统上传的业务申请编号 |
| systemSource | 系统来源 | String | Y | |

##### 应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| applyment_state | 申请单状态 | String | Y | 1、APPLYMENT_STATE_EDITTING（编辑中）：提交申请发生错误导致，请尝试重新提交。<br>2、APPLYMENT_STATE_AUDITING（审核中）：申请单正在审核中，超级管理员用微信打开“签约链接”，完成绑定微信号后，申请单进度将通过微信公众号通知超级管理员，引导完成后续步骤。<br>3、APPLYMENT_STATE_REJECTED（已驳回）：请按照驳回原因修改申请资料，超级管理员用微信打开“签约链接”，完成绑定微信号，后续申请单进度将通过微信公众号通知超级管理员。<br>4、APPLYMENT_STATE_TO_BE_CONFIRMED（待账户验证）：请超级管理员使用微信打开返回的“签约链接”，根据页面指引完成账户验证。<br>5、APPLYMENT_STATE_TO_BE_SIGNED（待签约）：请超级管理员使用微信打开返回的“签约链接”，根据页面指引完成签约。<br>6、APPLYMENT_STATE_SIGNING（开通权限中）：系统开通相关权限中，请耐心等待。<br>7、APPLYMENT_STATE_FINISHED（已完成）：商户入驻申请已完成。<br>8、APPLYMENT_STATE_CANCELED（已作废）：申请单已被撤销。 |
| applyment_state_msg | 申请状态描述 | String | Y | 申请状态描述 示例值：审核中 |
| sign_url | 超级管理员签约链接 | String | N | 1、超级管理员用微信扫码，关注“微信支付商家助手”公众号后，公众号将自动发送签约消息；超管需点击消息，根据指引完成核对联系信息、账户验证、签约等操作。<br>2、超管完成核对联系信息，后续申请单进度可通过公众号自动通知超级管理员 |
| sub_mchid | 返回信息 | String | N | 特约商户号，当申请单状态为APPLYMENT_STATE_FINISHED时才返回 |


#### (14)、支付结果通知

##### 业务功能
支付完成后，公共服务会把相关支付结果及用户信息通过数据流的形式发送给业务系统，业务系统需要接收处理。
  
##### 处理流程
* 业务系统向公共支付服务发送支付请求；  
* 公共服务完成支付处理；  
* 公共服务将支付结果以及订单信息，通过支付时传入的systemNotifyUrl，进行异步通知。  

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| AppId | 服务商AppId | String | Y | |
| MchId | 服务商商户号 | String | Y | |
| SubAppId | 子商户AppId | String | Y |   |
| SubMchId | 子商户号 | String | Y |  |
| ResultCode | 业务结果 | String | Y | SUCCESS/FAIL，该字段值为'SUCCESS'时可代表当前交易成功！ |
| ErrCode | 错误代码 | String | Y | 当ResultCode返回值为FAIL，且该字段值为'SIGNERROR'时。代表公共支付服务无法准确判断该笔交易是否成功，此时需业务系统调用'查询订单状态'接口确认当前订单是否支付成功！ |
| ErrCodeDes | 错误代码描述 | String | Y | |
| OpenId | 用户标识 | String | Y | |
| WxOrderNo | 支付流水号 | String | Y | |
| TimeEnd | 交易结束时间 | String | Y |  |
| TotalFee | 订单金额（分） | String | Y | 注：返回金额单位为'分'，业务处理且有必要时需自行转换 |
| SystemSource | 系统来源 | String | Y |  |
| OrderNo | 订单号 | String | Y |  |



#### 3、淘淘谷接口
#### (1)、淘淘谷支付

##### 业务功能
该接口用于进行微信和支付宝的主扫、被扫以及微信小程序支付功能。

##### 处理流程
* 业务系统调用支付接口到公共服务；  
* 公共服务返回支付结果，或支付所需的参数。

##### 接口路径
/v1.0/ttg/payment/ttgPay

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| open_id | 商户门店 open_id | String | Y | 由淘淘谷分配 |
| open_key | 商户密钥 | String | Y | 由淘淘谷分配 |
| out_no | 业务系统订单号 | String | Y | 只 允 许 使 用 数 字 、 字 母|
| ord_name | 订单名称 | String | Y |  |
| pmt_tag | 支付方式标签 | String | Y |  |
| trade_amount | 交易金额 | String | Y | 以'分'为单位 |
| payment | 支付方式 | String | Y | NATIVE：主扫；<br>MICROPAY：被扫；<br>JSAPI：小程序；|
| auth_code | 付款码code值 | String | N | 当payment为MICROPAY时必填 |
| sub_appid | 小程序appid | String | N | 当payment为JSAPI时必填 |
| sub_openid | 小程序用户openid | String | N | 当payment为JSAPI时必填 |
| notify_url | 回调url | String | N | 传入则进行回调，不传需要调用查询订单接口确认订单是否支付成功 |
| royalty | 是否分账 | String | N | 1需分账2不分账|
| systemSource | 系统来源 | String | Y | 传入由注册接口返回的系统来源|
|


##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| code | 返回状态码 | String | Y | 当code值为200时，代表请求成功 |
| msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因 |
| data | 返回信息 | String | Y | 当code值为200时，包含用于主扫或小程序支付所需要的参数 |


##### data字段json数据
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| ord_no | 交易流水单号 | String | Y | |
| trade_qrcode | 二维码字符串 | String | N | 当支付方式为NATIVE时返回，用于生成二维码发起支付 |
| timeStamp | 时间戳 | String | N | 当支付方式为JSAPI时返回|
| nonceStr | 随机字符串 | String | N | 当支付方式为JSAPI时返回|
| signType | 签名方式 | String | N | 当支付方式为JSAPI时返回|
| package | 预支付标识 | String | N | 当支付方式为JSAPI时返回|
| paySign | 签名 | String | N | 当支付方式为JSAPI时返回|

#### (2)、淘淘谷退款

##### 业务功能
该接口用于进行微信和支付宝的主扫、被扫以及微信小程序支付退款功能。

##### 处理流程
* 业务系统调用退款接口到公共服务；  
* 公共服务返回申请退款结果，退款进度通过退款查询接口进行查询。

##### 接口路径
/v1.0/ttg/refundMent/ttgRefund

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| open_id | 商户门店 open_id | String | Y | 由淘淘谷分配 |
| open_key | 商户密钥 | String | Y | 由淘淘谷分配 |
| out_no | 业务系统订单号 | String | Y | 禁止包含'_'|
| refund_out_no | 业务系统退款单号 | String | Y |  |
| refund_amount | 退款金额 | String | Y | 以分为单位，没有小数 点） |
| is_profit_refund | 是否为分账退款 | String | Y | 1：是，2：否（要退款的订单是否为需分账的订单） |
|


##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| code | 返回状态码 | String | Y | 当code值为200时，代表请求成功 |
| msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因 |
| data | 返回信息 | String | Y | 当code值为200时，包含退款详细信息|


##### data字段json数据
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| ord_no | 系统退款订单号 | String | Y |
| trade_amount | 退款金额 | String | Y |
| trade_time | 完成时间 | String | Y | |
| status | 状态 | String | Y | 1 成功，其它值为不成功|

#### (3)、添加分账接收方

##### 业务功能


##### 处理流程
* 

##### 接口路径
/v1.0/ttg/profit/addReceiver

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| mct_no | 商户编号 | String | Y | |

##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| code | 返回状态码 | String | Y | 当code值为200时，代表添加成功 |
| msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因 |
| data | 返回信息 | String | Y |  |

#### (4)、解除分账接收方

##### 业务功能


##### 处理流程
* 

##### 接口路径
/v1.0/ttg/profit/removeReceiver

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| mct_no | 商户编号 | String | Y | |

##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| code | 返回状态码 | String | Y | 当code值为200时，代表解除成功 |
| msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因 |
| data | 返回信息 | String | Y |  |

#### (5)、已添加分账接收方查询

##### 业务功能
该接口用于进行微信和支付宝的主扫、被扫以及微信小程序支付功能。

##### 处理流程
* 业务系统调用支付接口到公共服务；  
* 公共服务返回支付结果，或支付所需的参数。

##### 接口路径
/v1.0/ttg/profit/queryreceiver

##### 请求参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
无


##### 请求成功应答参数
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| code | 返回状态码 | String | Y | 当code值为200时，代表请求成功 |
| msg | 返回信息 | String | Y | 返回信息，如非空，为错误原因 |
| data | 返回信息 | String | Y | 当code值为200时，包含已添加的分账接收方信息 |


##### data字段json数据
| 字段 | 描述 | 类型 | 必填 | 备注 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| mct_no | 商户编号 | Array | Y | |

#### 接口加签说明

##### 业务功能
使用api密钥对请求中的参数进行签名，保证交易的安全性，防止数据被伪造。

##### 接口加签明示
| 序号 | 接口名称 | 是否加签 |
| ---------- | ---------- | ---------- |
| 1 | 小程序支付 | Y |
| 2 | NATIVE支付 | Y |
| 3 | 付款码支付 | Y |
| 4 | 查询支付订单状态 | Y |
| 5 | 申请退款 | Y |
| 6 | 查询退款订单状态 | Y |
| 7 | 下载交易账单 | Y |
| 8 | 发起单次分账 | Y |
| 9 | 发起多次分账 | Y |
| 10 | 添加分账接收方 | Y |
| 11 | 查询分账结果 | Y |
| 12 | 提交入驻申请 | Y |
| 13 | 查询入驻申请单状态 | Y |
| 14 | 注册（注册至公共服务） | N |
##### 加签方法
* 将请求参数转换为json字符串并去空格，并拼上&和apiKey；  
例：  
````
{"openId":"onfLz5NuGFTZUK6WmOkZShdYkwbY","orderNo":"A-010000520081210351171443","payChannel":"wx","profitSharing":"N","subAppId":"wx182ecd985d798713","subMchId":"1601985045","systemNotifyUrl":"http://t487eb.natappfree.cc/pay-core/v1.0/bsystem/paynotify","systemSource":3,"totalFee":0.01}&88b93969506b4e9b9e4be0dd9832b0da
````
* 将组装后的字符串进行MD5加密生成签名；  
* 将生成后的签名在请求时放入name为‘sign’的请求头中。  

#### 附录
##### 错误代码说明
| 名称 | 描述 | 支付状态 | 原因 | 解决方案 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| SYSTEMERROR | 接口返回错误 | 支付结果未知 | 系统超时 | 请立即调用被扫订单结果查询API，查询当前订单状态，并根据订单的状态决定下一步的操作 |
| PARAM_ERROR | 参数错误 | 支付确认失败 | 请求参数未按指引进行填写 | 请根据接口返回的详细信息检查您的程序 |
| ORDERPAID | 订单已支付 | 支付确认失败 | 订单号重复 | 请确认该订单号是否重复支付，如果是新单，请使用新订单号提交 |
| NOAUTH | 商户无权限 | 支付确认失败 | 商户没有开通被扫支付权限 | 请开通商户号权限。请联系产品或商务申请 |
| AUTHCODEEXPIRE | 二维码已过期，请用户在微信上刷新后再试 | 支付确认失败 | 用户的条码已经过期 | 请收银员提示用户，请用户在微信上刷新条码，然后请收银员重新扫码。 直接将错误展示给收银员 |
| NOTENOUGH | 余额不足 | 支付确认失败 | 用户的零钱余额不足 | 请收银员提示用户更换当前支付的卡，然后请收银员重新扫码。建议：商户系统返回给收银台的提示为“用户余额不足.提示用户换卡支付” |
| NOTSUPORTCARD | 不支持卡类型 | 支付确认失败 | 用户使用卡种不支持当前支付形式 | 请用户重新选择卡种 建议：商户系统返回给收银台的提示为“该卡不支持当前支付，提示用户换卡支付或绑新卡支付” |
| ORDERCLOSED | 订单已关闭 | 支付确认失败 | 该订单已关 | 商户订单号异常，请重新下单支付 |
| ORDERREVERSED | 订单已撤销 | 支付确认失败 | 当前订单已经被撤销 | 当前订单状态为“订单已撤销”，请提示用户重新支付 |
| BANKERROR | 银行系统异常 | 支付结果未知 | 银行端超时 | 请立即调用被扫订单结果查询API，查询当前订单的不同状态，决定下一步的操作。 |
| USERPAYING | 用户支付中，需要输入密码 | 支付结果未知 | 该笔交易因为业务规则要求，需要用户输入支付密码。 | 等待5秒，然后调用被扫订单结果查询API，查询当前订单的不同状态，决定下一步的操作。 |
| AUTH_CODE_ERROR | 付款码参数错误 | 支付确认失败 | 请求参数未按指引进行填写 | 每个二维码仅限使用一次，请刷新再试 |
| AUTH_CODE_INVALID | 付款码检验错误 | 支付确认失败 | 收银员扫描的不是微信支付的条码 | 请扫描微信支付被扫条码/二维码 |
| XML_FORMAT_ERROR | XML格式错误 | 支付确认失败 | XML格式错误 | 请检查XML参数格式是否正确 |
| REQUIRE_POST_METHOD | 请使用post方法 | 支付确认失败 | 未使用post传递参数 | 请检查请求参数是否通过post方法提交 |
| SIGNERROR | 签名错误 | 支付确认失败 | 参数签名结果不正确 | 请检查签名参数和方法是否都符合签名算法要求 |
| LACK_PARAMS | 缺少参数 | 支付确认失败 | 缺少必要的请求参数 | 请检查参数是否齐全 |
| NOT_UTF8 | 编码格式错误 | 支付确认失败 | 未使用指定编码格式 | 请使用UTF-8编码格式 |
| BUYER_MISMATCH | 支付帐号错误 | 支付确认失败 | 暂不支持同一笔订单更换支付方 | 请确认支付方是否相同 |
| APPID_NOT_EXIST | APPID不存在 | 支付确认失败 | 参数中缺少APPID | 请检查APPID是否正确 |
| MCHID_NOT_EXIST | MCHID不存在 | 支付确认失败 | 参数中缺少MCHID | 请检查MCHID是否正确 |
| OUT_TRADE_NO_USED | 商户订单号重复 | 支付确认失败 | 同一笔交易不能多次提交 | 请核实商户订单号是否重复提交 |
| APPID_MCHID_NOT_MATCH | appid和mch_id不匹配 | 支付确认失败 | appid和mch_id不匹配 | 请确认appid和mch_id是否匹配 |
| INVALID_REQUEST | 无效请求 | 支付确认失败 | 商户系统异常导致，商户权限异常、重复请求支付、证书错误、频率限制等 | 请确认商户系统是否正常，是否具有相应支付权限，确认证书是否正确，控制频率 |
| TRADE_ERROR | 交易错误 | 支付确认失败 | 业务错误导致交易失败、用户账号异常、风控、规则限制等 | 请确认帐号是否存在异常 |